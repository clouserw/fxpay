"function"!=typeof window.require&&(window.require=function(a){for(var b,c=a.split("/"),d=window,e="",f=0;f<c.length;f++){if(""===e?e=c[f]:e+="."+c[f],b=d[c[f]],"undefined"==typeof b)throw new Error('The required module "'+a+'" is not defined as a global. First undefined part: "'+e+'"');d=b}return b}),"undefined"==typeof window.fxpay&&(window.fxpay={}),"undefined"==typeof window.fxpay.settings&&(window.fxpay.settings={}),function(a){"use strict";var b={version:"0.0.5"},c={allowAnyAppReceipt:!1,apiUrlBase:"https://marketplace.firefox.com",apiVersionPrefix:"/api/v1",apiTimeoutMs:null,fakeProducts:!1,log:window.console||{debug:function(){},error:function(){},info:function(){},log:function(){},warn:function(){}},receiptCheckSites:["https://receiptcheck.marketplace.firefox.com","https://marketplace.firefox.com"],appSelf:null,hasAddReceipt:null,onerror:function(a){throw a},oninit:function(){a.log.info("fxpay version:",a.libVersion),a.log.info("initialization ran successfully")},onrestore:function(b,c){b?a.log.error("error while restoring product:",c.productId,"message:",b):a.log.info("product",c.productId,"was restored from receipt")},initError:"NOT_INITIALIZED",localStorage:window.localStorage||null,localStorageKey:"fxpayReceipts",mozPay:navigator.mozPay||null,mozApps:navigator.mozApps||null,libVersion:b.version};a.configure=function(b,d){if(d=d||{},d.reset)for(var e in c)a[e]=c[e];for(var f in b){if("undefined"==typeof a[f])return a.log.error("configure() received an unknown setting:",f),a.onerror("INCORRECT_USAGE");a[f]=b[f]}return a}}(window.fxpay.settings),"undefined"==typeof window.fxpay&&(window.fxpay={}),"undefined"==typeof window.fxpay.api&&(window.fxpay.api={}),function(a){"use strict";function b(a,b){b=b||{},this.baseUrl=a,this.log=d.log,this.timeoutMs=d.apiTimeoutMs||1e4,this.versionPrefix=d.apiVersionPrefix||void 0}function c(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}var d=require("fxpay/settings");a.API=b,b.prototype.url=function(a,b){b=b||{},b.versioned="undefined"!=typeof b.versioned?b.versioned:!0;var c=this.baseUrl;return b.versioned&&(c+=this.versionPrefix||""),c+=a},b.prototype.request=function(a,b,e,f,g){g=g||{};var h=e?"application/x-www-form-urlencoded":null;g.contentType=g.contentType||h;var i={Accept:"application/json"};g.contentType&&(i["Content-Type"]=g.contentType),g.headers=g.headers||{};for(var j in i)j in g.headers||(g.headers[j]=i[j]);g.headers["x-fxpay-version"]=d.libVersion;var k,l=this.log,m=this;f||(f=function(a,b){if(a)throw a;l.info("default callback received data:",b)}),k=/^http(s)?:\/\/.*/.test(b)?b:this.url(b);var n=new XMLHttpRequest({mozSystem:!0}),o={abort:function(){l.error("xhr abort: path:",b),f("API_REQUEST_ABORTED")},error:function(a){l.error("xhr error: ",a,"path:",b),f("API_REQUEST_ERROR")},load:function(){var a;if("2"!==this.status.toString().slice(0,1)){var b="BAD_API_RESPONSE";return l.error(b,"status:",this.status,"for URL:",k),l.debug(b,"response:",this.responseText),f("BAD_API_RESPONSE")}l.debug("xhr load: GOT",this.responseText);try{a=JSON.parse(this.responseText)}catch(c){var b="BAD_JSON_RESPONSE";return l.error(b,"for URL:",k,"exception",c,"response:",this.responseText),f(b)}f(null,a)},timeout:function(){l.error("xhr request to",k,"timed out after",m.timeoutMs,"ms"),f("API_REQUEST_TIMEOUT")}};for(var p in o)n.addEventListener(p,o[p],!1);l.debug("opening",a,"to",k),n.timeout=m.timeoutMs,n.open(a,k,!0);for(var q in g.headers)n.setRequestHeader(q,g.headers[q]);"application/x-www-form-urlencoded"===g.contentType&&e&&(e=c(e)),n.send(e)},b.prototype.get=function(a,b,c){this.request("GET",a,null,b,c)},b.prototype.del=function(a,b,c){this.request("DELETE",a,null,b,c)},b.prototype.post=function(a,b,c,d){this.request("POST",a,b,c,d)},b.prototype.put=function(a,b,c,d){this.request("PUT",a,b,c,d)}}(window.fxpay.api),"undefined"==typeof window.fxpay&&(window.fxpay={}),"undefined"==typeof window.fxpay.products&&(window.fxpay.products={}),function(a){"use strict";function b(a){return{productId:a.guid,name:a.name,smallImageUrl:a.logo_url}}var c=require("fxpay/settings"),d=require("fxpay/api").API;a.all=function(a){var e=[];if(c.initError)return c.log.error("init failed:",c.initError),a(c.initError,e);var f,g=new d(c.apiUrlBase),h=encodeURIComponent(c.appSelf.origin);c.fakeProducts?(c.log.warn("about to fetch fake products"),f="/payments/stub-in-app-products/"):(c.log.info("about to fetch real products for app",h),f="/payments/"+h+"/in-app/?active=1"),g.get(f,function(d,f){if(d)return a(d,e);c.log.info("total products fetched:",f.objects.length);for(var g=0;g<f.objects.length;g++){var h=f.objects[g],i=b(h);e.push(i)}a(d,e)})},a.getById=function(a,e,f){f=f||{},"undefined"==typeof f.fetchStubs&&(f.fetchStubs=!1),f.api||(f.api=new d(c.apiUrlBase));var g,h=encodeURIComponent(c.appSelf.origin);g=f.fetchStubs?"/payments/stub-in-app-products/"+a.toString()+"/":"/payments/"+h+"/in-app/"+a.toString()+"/",c.log.info("fetching product info at URL",g,"fetching stubs?",f.fetchStubs),f.api.get(g,function(d,f){return d?(c.log.error("Error fetching product info",d),e(d,{productId:a})):void e(null,b(f))})}}(window.fxpay.products),"undefined"==typeof window.fxpay&&(window.fxpay={}),"undefined"==typeof window.fxpay.receipts&&(window.fxpay.receipts={}),function(a){"use strict";function b(a,b){var c=j.appSelf.addReceipt(a);c.onsuccess=function(){j.log.info("item fully purchased and receipt installed"),b(null)},c.onerror=function(){var a=this.error.name;j.log.error("error calling app.addReceipt",a),b(a)}}function c(a,b){var c=j.localStorage.getItem(j.localStorageKey);c=c?JSON.parse(c):[],-1===c.indexOf(a)?c.push(a):j.log.info("not adding receipt",a.substring(0,5),"because it has already been added"),j.localStorage.setItem(j.localStorageKey,JSON.stringify(c)),b(null)}function d(a,b){var c={};if("string"!=typeof a)return j.log.error("unexpected receipt type:",typeof a),b("INVALID_RECEIPT",c);var d=a.split("~");if(1===d.length)c=d[0];else{if(2!==d.length)return j.log.error("wrong number of tilde separated segments in receipt"),b("INVALID_RECEIPT",c);c=d[1]}var e=c.split(".");if(3!==e.length)return j.log.error("wrong number of JWT segments in receipt:",e.length),b("INVALID_RECEIPT",c);c=e[1];try{c=g(c)}catch(f){return j.log.error("error base64 decoding receipt:",f.name,f.message),b("INVALID_RECEIPT",c)}try{c=JSON.parse(c)}catch(f){return j.log.error("error parsing receipt JSON:",f.name,f.message),b("INVALID_RECEIPT",c)}return b(null,c)}function e(a,b){var c={};if(!a.product)return j.log.error("receipt is missing the product field"),b("INVALID_RECEIPT",c);if(!a.product.url)return j.log.error("receipt is missing product.url"),b("INVALID_RECEIPT",c);if(!a.product.storedata)return j.log.error("receipt is missing product.storedata"),b("INVALID_RECEIPT",c);if("string"!=typeof a.product.storedata)return j.log.error("unexpected storedata in receipt:",a.product.storedata),b("INVALID_RECEIPT",c);var d={};if(a.product.storedata.split("&").forEach(function(a){var b=a.split("=");d[b[0]]=decodeURIComponent(b[1])}),c.productId=d.inapp_id,!c.productId)return j.log.error("Could not find productId in storedata:",a.product.storedata),b("INVALID_RECEIPT",c);var e=a.product.url;e&&!e.match(/^(http(s)?|app):\/\/.*$/g)&&(e="app://"+e),c.productUrl=e;var f="test-receipt"===a.typ;if(f&&!j.fakeProducts)return j.log.error("cannot restore test receipts when fakeProducts is false"),b("TEST_RECEIPT_NOT_ALLOWED",c);var g=j.fakeProducts&&f;return j.allowAnyAppReceipt||g||e===j.appSelf.origin?void b(null,c):(j.log.error("app origin",j.appSelf.origin,"does not match receipt product URL",e),b("INVALID_RECEIPT",c))}function f(a,b){for(var c=!1,d=a.verify||"",e=0;e<j.receiptCheckSites.length;e++){var f=j.receiptCheckSites[e];if(0===d.indexOf(f)){c=!0;break}}return c?void b(null,a):(j.log.error("Receipt check URL",a.verify,"is not whitelisted. Valid choices:",j.receiptCheckSites),b("INVALID_RECEIPT",a))}function g(a){switch(a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),a.length%4){case 0:break;case 1:a+="===";break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}return atob(a)}var h=require("fxpay/api").API,i=require("fxpay/products"),j=require("fxpay/settings");a.all=function(){var a=0,b=[];j.appSelf&&j.appSelf.receipts&&(a=j.appSelf.receipts.length,b=Array.prototype.slice.call(j.appSelf.receipts));var c=0,d=j.localStorage.getItem(j.localStorageKey);if(d){d=JSON.parse(d);for(var e=0;e<d.length;e++)-1===b.indexOf(d[e])?(b.push(d[e]),c++):j.log.info("ignoring dupe receipt fetched from local storage",d[e].substring(0,5))}return j.log.info("receipts fetched from mozApps:",a),j.log.info("receipts fetched from localStorage:",c),b},a.add=function(a,d){return j.hasAddReceipt?(j.log.info("adding receipt to device with addReceipt"),b(a,d)):(j.log.info("adding receipt to device with localStorage"),c(a,d))},a.verify=function(b,c){a.verifyData(b,function(a,d,e){if(a)return c(a,e);var f=d.iss;j.log.info("derived base API URL from receipt:",f);var g=new h(f);j.log.info("about to post to verifier URL",d.verify),g.post(d.verify,b,function(a,f){return a?(j.log.error("Error verifying receipt:",a),c(a,e)):(j.log.info("verification result:",f),"ok"!==f.status?(j.log.error("receipt",b.substring(0,10),"is invalid; service returned:",f.status,f.reason),c("INVALID_RECEIPT",e)):(j.log.info("validated receipt for",e),void i.getById(e.productId,function(a,b){return a?c(a,e):c(null,b)},{fetchStubs:"test-receipt"===d.typ,api:g})))},{contentType:"text/plain"})})},a.verifyData=function(a,b){d(a,function(a,c){return a?b(a,c,{}):void e(c,function(a,d){return a?b(a,c,d):void f(c,function(a){return a?b(a,c,d):void b(null,c,d)})})})}}(window.fxpay.receipts),"undefined"==typeof window.fxpay&&(window.fxpay={}),function(a){"use strict";function b(a,b,g){g=g||{},g.maxTries=g.maxTries||void 0,g.pollIntervalMs=g.pollIntervalMs||void 0;var h={productId:a},i=f.log,j=new e(f.apiUrlBase);i.debug("starting purchase for product",a);var k="/webpay/inapp/prepare/";j.post(k,{inapp:a},function(a,e){if(a)return b(a);i.debug("xhr load: JSON",e);var k=f.mozPay([e.webpayJWT]);k.onerror=function(){i.error("mozPay: received onerror():",this.error.name),b(this.error.name,h)},k.onsuccess=function(){i.debug("mozPay: received onsuccess()"),d(j,j.url(e.contribStatusURL,{versioned:!1}),function(a,d){c(a,b,d,h)},{maxTries:g.maxTries,pollIntervalMs:g.pollIntervalMs})}})}function c(a,b,c,d){return a?b(a,d):(f.log.info("received completed transaction:",c),void h.add(c.receipt,function(a){return a?b(a,d):void g.getById(d.productId,function(a,c){return a?b(a,c):void b(null,c)},{fetchStubs:f.fakeProducts})}))}function d(a,b,c,e){e=e||{},e.maxTries=e.maxTries||10,e.pollIntervalMs=e.pollIntervalMs||1e3,e._tries=e._tries||1;var g=f.log;return g.debug("Getting transaction state at",b,"tries=",e._tries),e._tries>e.maxTries?(g.error("Giving up on transaction at",b,"after",e._tries,"tries"),c("TRANSACTION_TIMEOUT")):void a.get(b,function(f,h){return f?c(f):"complete"===h.status?c(null,h):"incomplete"!==h.status?(g.error("transaction status",h.status,"from",b,"was unexpected"),c("INVALID_TRANSACTION_STATE")):(g.debug("Re-trying incomplete transaction in",e.pollIntervalMs,"ms"),void window.setTimeout(function(){d(a,b,c,{maxTries:e.maxTries,pollIntervalMs:e.pollIntervalMs,_tries:e._tries+1})},e.pollIntervalMs))})}var e=require("fxpay/api").API,f=require("fxpay/settings"),g=require("fxpay/products"),h=require("fxpay/receipts");a.configure=function(){f.configure.apply(f,arguments)},a.configure({},{reset:!0}),a.init=function(b){function c(a){return f.initError=a,f.onerror(f.initError)}if(b=b||{},a.configure(b),!f.mozApps||!f.mozApps.getSelf)return f.log.error("Missing pay platform: mozApps was falsey"),c("PAY_PLATFORM_UNAVAILABLE");var d=f.mozApps.getSelf();d.onsuccess=function(){if(f.appSelf=this.result,!f.appSelf)return f.log.error("falsey app object from getSelf()",f.appSelf),c("NOT_INSTALLED_AS_APP");var a=f.appSelf.manifest.permissions;if(!a||!a.systemXHR)return f.log.error("incorrect manifest permissions",f.appSelf.manifest),c("MISSING_XHR_PERMISSION");if(f.hasAddReceipt=!!f.appSelf.addReceipt,!f.hasAddReceipt&&!f.localStorage)return f.log.error("no way to store receipts on this platform"),c("PAY_PLATFORM_UNAVAILABLE");for(var b,d=0,e=h.all(),g=0;g<e.length;g++)b=e[g],f.log.info("Installed receipt: "+b),d++,h.verify(b,f.onrestore);f.log.info("Number of receipts installed: "+d),f.initError=null,f.oninit()},d.onerror=function(){var a=this.error.name;f.log.error("mozApps.getSelf() returned an error",a),c(a)}},a.purchase=function(a,c,d){d=d||{},d.maxTries=d.maxTries||void 0,d.pollIntervalMs=d.pollIntervalMs||void 0;var e={};return c||(c=function(a,b){if(a)throw a;console.log("product",b.productId,"purchased")}),f.initError?(f.log.error("init failed:",f.initError),c(f.initError,e)):f.mozPay?void b(a,c,d):(f.log.error("Missing pay platform: mozPay was falsey"),c("PAY_PLATFORM_UNAVAILABLE",e))},a.getProducts=function(){g.all.apply(g,arguments)}}(window.fxpay);